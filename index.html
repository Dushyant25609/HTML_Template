<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIO Viewpoint Dashboard</title>

  <!-- ✅ Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Global styles shared across all tables */
    body {
      font-family: Arial, sans-serif;
    }

    table td {
      vertical-align: top;
    }

    .factors-table {
      border-collapse: collapse;
      font-family: Arial, sans-serif;
      border-bottom: 2px solid #333;
      margin-bottom: 8px;
    }

    .factors-table th,
    .factors-table td {
      border: none;
      padding: 8px 12px;
    }

    .factors-table thead th {
      background-color: #f8f9fa;
      font-weight: bold;
      text-align: center;
      border-top: 2px solid #333;
      border-bottom: 2px solid #333;
    }

    .factors-table tbody td:first-child {
      font-weight: 600;
      width: 200px;
    }

    .factors-table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .factors-table tbody tr:nth-child(odd) {
      background-color: white;
    }

    .factors-table tbody td:last-child {
      text-align: justify;
      line-height: 1.4;
      font-size: 14px;
    }

    /* Separated rows - add top and bottom border */
    .separated-row {
      border-top: 2px solid #333 !important;
      border-bottom: 2px solid #333 !important;
    }

    /* Input field styling when editing */
    .factors-table input {
      font-family: inherit;
      color: inherit;
      outline: none;
    }

    .factors-table input:focus {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 2px;
      padding: 2px 4px;
    }

    /* Cursor pointer for interactive table elements */
    tbody td:first-child,
    tbody td:last-child,
    th:not(.text-xs) {
      cursor: pointer;
    }

    /* Hover effects for editable cells */
    tbody td:first-child:hover,
    tbody td:last-child:hover,
    th:not(.text-xs):hover {
      background-color: #f8f9fa;
      transition: background-color 0.2s ease;
    }

    /* Table row hover effect */
    tbody tr:hover {
      background-color: #f8f9fa;
    }

    /* Preview Mode Button */
    .preview-btn {
      background: #007bff;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .preview-btn:hover {
      background: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
      color: white;
      text-decoration: none;
    }

    .preview-btn:active {
      transform: translateY(0);
    }

    /* Action Buttons */
    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      border: none;
      min-width: 120px;
      justify-content: flex-start;
    }
    
    .preview-btn-new {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .preview-btn-new:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .json-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .json-btn:hover {
      background: linear-gradient(135deg, #059669, #047857);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .copy-btn {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    
    .copy-btn:hover {
      background: linear-gradient(135deg, #7c3aed, #6d28d9);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    .action-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Header -->
  <header class="bg-blue-900 text-white py-6 text-center shadow">
    <h1 id="header-title" class="text-3xl font-bold">CIO Viewpoint Dashboard</h1>
    <p id="header-subtitle" class="text-sm text-blue-200">Key Drivers of Equities | Updated <span id="header-date">October 2025</span></p>
    <p class="text-xs text-blue-300 mt-2">💡 Double-click headers and text cells to edit | Click weight dots in Table 2 for quick position changes | Double-click Table 3 rows or weight dots/triangles for detailed editing | Double-click empty weight area in Table 2 to hide dots | Double-click range handles to adjust values</p>
  </header>

  <!-- Action Buttons -->
  <div class="fixed top-4 right-4 z-50 flex flex-row gap-3 p-2 bg-white/90 backdrop-blur-sm rounded-lg shadow-lg border border-gray-200">
    <button onclick="previewJSON()" class="action-btn json-btn">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
      </svg>
      View JSON
    </button>
    <button onclick="copyCurrentJSON()" class="action-btn copy-btn">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
      </svg>
      Copy JSON
    </button>
  </div>

  <!-- Global JavaScript Functions -->
  <script>
    // Global variables
    window.headerData = {
      factorHeader: "Factor",
      implicationHeader: "Implication for Equities", 
      cioViewHeader: "CIO View"
    };

    // Set current date in header
    const headerDateElement = document.getElementById("header-date");
    if (headerDateElement) {
      headerDateElement.textContent = new Date().toLocaleDateString();
    }

    // Global editable functionality for headers and text cells
    function makeHeadersEditable() {
      const editableHeaders = document.querySelectorAll('th:not(.text-xs)');
      editableHeaders.forEach((cell, index) => {
        cell.addEventListener('dblclick', function() {
          if (this.querySelector('input')) return; // Already editing
          
          const originalText = this.textContent.trim();
          const input = document.createElement('input');
          input.type = 'text';
          input.value = originalText;
          input.style.width = '100%';
          input.style.border = 'none';
          input.style.background = 'transparent';
          input.style.fontSize = 'inherit';
          input.style.fontWeight = 'inherit';
          input.style.textAlign = 'inherit';
          input.style.padding = '4px';
          
          this.innerHTML = '';
          this.appendChild(input);
          input.focus();
          input.select();
          
          const saveEdit = () => {
            const newValue = input.value || originalText;
            this.textContent = newValue;
            
            // Update header data based on column position
            if (index === 0) {
              window.headerData.factorHeader = newValue;
            } else if (index === 1) {
              window.headerData.implicationHeader = newValue;
            } else if (index === 2) {
              window.headerData.cioViewHeader = newValue;
            }
            
            saveDataToStorage();
          };
          
          input.addEventListener('blur', saveEdit);
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') saveEdit();
            if (e.key === 'Escape') this.textContent = originalText;
          });
        });
      });
    }

    // Global function to make text cells editable
    function makeTextCellsEditable() {
      const dataCells = document.querySelectorAll('tbody td:first-child, tbody td:last-child');
      dataCells.forEach((cell, index) => {
        cell.addEventListener('dblclick', function() {
          if (this.querySelector('input')) return; // Already editing
          
          const originalText = this.textContent.trim();
          const input = document.createElement('input');
          input.type = 'text';
          input.value = originalText;
          input.style.width = '100%';
          input.style.border = 'none';
          input.style.background = 'transparent';
          input.style.fontSize = 'inherit';
          input.style.fontWeight = 'inherit';
          input.style.textAlign = 'inherit';
          input.style.padding = '4px';
          
          this.innerHTML = '';
          this.appendChild(input);
          input.focus();
          input.select();
          
          const saveEdit = () => {
            const newValue = input.value || originalText;
            this.textContent = newValue;
            
            // Update the data array based on which table this cell belongs to
            const row = this.parentElement;
            const tbody = row.parentElement;
            const rowIndex = Array.from(tbody.children).indexOf(row);
            
            // Check which table and update appropriate data
            if (tbody.id === 'factors-body') {
              if (this === row.firstElementChild) {
                window.factorsData[rowIndex].factor = newValue;
              } else if (this === row.lastElementChild) {
                window.factorsData[rowIndex].cioView = newValue;
              }
            } else if (tbody.id === 'cio-view-body') {
              if (this === row.firstElementChild) {
                if (window.cioViewData && window.cioViewData[rowIndex]) {
                  window.cioViewData[rowIndex].assetClass = newValue;
                }
              } else if (this === row.lastElementChild) {
                if (window.cioViewData && window.cioViewData[rowIndex]) {
                  window.cioViewData[rowIndex].comments = newValue;
                }
              }
            } else if (tbody.id === 'table3-view-body') {
              if (this === row.firstElementChild) {
                if (window.table3ViewData && window.table3ViewData[rowIndex]) {
                  window.table3ViewData[rowIndex].assetClass = newValue;
                }
              } else if (this === row.lastElementChild) {
                if (window.table3ViewData && window.table3ViewData[rowIndex]) {
                  window.table3ViewData[rowIndex].comments = newValue;
                }
              }
            }
            
            saveDataToStorage();
          };
          
          input.addEventListener('blur', saveEdit);
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') saveEdit();
            if (e.key === 'Escape') this.textContent = originalText;
          });
        });
      });
    }
  </script>

  <!-- Table 1: Equity Factors with Range Sliders -->
  <main class="max-w-7xl mx-auto mt-8 px-4">
    <!-- Table 1 Specific Styles -->
    <style>
      /* Range Slider Styles for Table 1 */
      .factors-table tbody td:nth-child(2) {
        text-align: center;
        vertical-align: middle;
        width: 300px;
        padding: 8px;
      }

      .range-slider {
        position: relative;
        width: 280px;
        height: 30px;
        margin: 0 auto;
        display: flex;
        align-items: center;
      }

      .range-track {
        width: 100%;
        height: 8px;
        background-color: #ccc;
        border-radius: 4px;
        position: relative;
        margin: 0 10px;
      }

      .range-thumb {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        align-items: center;
        gap: 4px;
        z-index: 2;
      }

      .range-handle {
        width: 20px;
        height: 20px;
        background-color: white;
        border: 3px solid #333;
        border-radius: 50%;
        cursor: pointer !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      /* Handle colors based on implication */
      .range-handle.positive { background-color: #22c55e; }
      .range-handle.neutral { background-color: #facc15; }
      .range-handle.negative { background-color: #ef4444; }

      /* SVG Arrow Styles */
      .svg-arrow {
        display: inline-flex;
        align-items: center;
        color: #333;
        width: 28px;
        height: 21px;
      }

      .svg-arrow.left { transform: rotate(180deg); }
      .svg-arrow.right { transform: rotate(0deg); }
      .svg-arrow svg { width: 100%; height: 100%; }

      /* Range edit popover styles */
      .range-edit-popover {
        animation: popoverFadeIn 0.2s ease-out;
      }

      @keyframes popoverFadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .range-edit-popover input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 6px;
        background: #ddd;
        border-radius: 3px;
        outline: none;
      }

      .range-edit-popover input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
      }

      .range-edit-popover input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #007bff;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }

      /* Additional hover feedback for range sliders */
      .range-slider:hover .range-track {
        opacity: 0.8;
      }
    </style>

    <!-- Table 1 Specific JavaScript Functions -->
    <script>
      // Table 1: Create factor row with range slider
      window.createFactorRow = function(item) {
        // Create SVG arrow based on trend
        let trendArrow = '';
        const svgArrow = `<svg width="28" height="21" viewBox="0 0 122.88 108.06" xmlns="http://www.w3.org/2000/svg">
          <path d="M58.94,24.28a14.27,14.27,0,0,1,20.35-20l39.49,40.16a14.28,14.28,0,0,1,0,20L80.09,103.79a14.27,14.27,0,1,1-20.35-20L74.82,68.41l-60.67-.29a14.27,14.27,0,0,1,.24-28.54l59.85.28L58.94,24.28Z" fill="currentColor"/>
        </svg>`;
        
        switch(item.trend) {
          case 'up':
            trendArrow = `<span class="svg-arrow right">${svgArrow}</span>`;
            break;
          case 'down':
            trendArrow = `<span class="svg-arrow left">${svgArrow}</span>`;
            break;
          case 'neutral':
          default:
            trendArrow = '';
            break;
        }

        // Determine handle color class based on implication
        let handleColorClass = '';
        switch(item.implication.toLowerCase()) {
          case 'positive': handleColorClass = 'positive'; break;
          case 'neutral': handleColorClass = 'neutral'; break;
          case 'negative': handleColorClass = 'negative'; break;
        }

        // Calculate position based on value (0-100) as percentage
        const rawPosition = Math.min(Math.max(item.value, 0), 100);
        const constrainedPosition = Math.min(Math.max(rawPosition, 3), 97);
        
        // Create the range slider visualization
        const rangeSlider = `
          <div class="range-slider">
            <div class="range-track">
              <div class="range-thumb" style="left: ${constrainedPosition}%;">
                ${trendArrow}
                <div class="range-handle ${handleColorClass}"></div>
              </div>
            </div>
          </div>
        `;

        return `
          <tr>
            <td>${item.factor}</td>
            <td>${rangeSlider}</td>
            <td>${item.cioView}</td>
          </tr>
        `;
      };

      // Table 1: Range handle editing functionality
      function addRangeHandleEditing() {
        const rangeHandles = document.querySelectorAll('.range-handle');
        rangeHandles.forEach((handle, index) => {
          handle.addEventListener('dblclick', function(e) {
            e.stopPropagation();
            
            const row = this.closest('tr');
            const rowIndex = Array.from(row.parentElement.children).indexOf(row);
            const factorData = window.factorsData[rowIndex];
            
            showRangeEditPopover(this, factorData, rowIndex);
          });
          
          handle.style.cursor = 'pointer';
        });
      }

      // Table 1: Show range edit popover
      function showRangeEditPopover(handle, factorData, rowIndex) {
        // Remove existing popover if any
        const existingPopover = document.querySelector('.range-edit-popover');
        if (existingPopover) {
          existingPopover.remove();
        }

        // Create popover
        const popover = document.createElement('div');
        popover.className = 'range-edit-popover';
        popover.style.cssText = `
          position: absolute;
          background: white;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 20px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          min-width: 250px;
          font-size: 14px;
        `;

        // Get handle position
        const handleRect = handle.getBoundingClientRect();
        popover.style.left = (handleRect.left + window.scrollX - 125) + 'px';
        popover.style.top = (handleRect.bottom + window.scrollY + 10) + 'px';

        // Create form content
        popover.innerHTML = `
          <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">Edit Range Settings</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Implication:</label>
            <select id="popover-implication" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="positive" ${factorData.implication.toLowerCase() === 'positive' ? 'selected' : ''}>Positive</option>
              <option value="neutral" ${factorData.implication.toLowerCase() === 'neutral' ? 'selected' : ''}>Neutral</option>
              <option value="negative" ${factorData.implication.toLowerCase() === 'negative' ? 'selected' : ''}>Negative</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Trend:</label>
            <select id="popover-trend" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="up" ${factorData.trend === 'up' ? 'selected' : ''}>Up</option>
              <option value="neutral" ${factorData.trend === 'neutral' ? 'selected' : ''}>Neutral</option>
              <option value="down" ${factorData.trend === 'down' ? 'selected' : ''}>Down</option>
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Value: <span id="value-display">${factorData.value}</span></label>
            <input type="range" id="popover-value" min="0" max="100" value="${factorData.value}" 
                   style="width: 100%; margin-bottom: 5px;"
                   oninput="document.getElementById('value-display').textContent = this.value">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
              <span>0</span>
              <span>50</span>
              <span>100</span>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeRangePopover()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveRangeChanges(${rowIndex})" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
          </div>
        `;

        document.body.appendChild(popover);
        window.currentRangePopover = popover;

        // Close popover when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closePopoverOnOutsideClick);
        }, 100);
      }

      // Table 1: Range popover utility functions
      function closePopoverOnOutsideClick(e) {
        const popover = document.querySelector('.range-edit-popover');
        if (popover && !popover.contains(e.target)) {
          closeRangePopover();
        }
      }

      window.closeRangePopover = function() {
        const popover = document.querySelector('.range-edit-popover');
        if (popover) {
          popover.remove();
          document.removeEventListener('click', closePopoverOnOutsideClick);
        }
      };

      window.saveRangeChanges = function(rowIndex) {
        const implication = document.getElementById('popover-implication').value;
        const trend = document.getElementById('popover-trend').value;
        const value = parseInt(document.getElementById('popover-value').value);

        // Update the data
        window.factorsData[rowIndex].implication = implication.charAt(0).toUpperCase() + implication.slice(1);
        window.factorsData[rowIndex].trend = trend;
        window.factorsData[rowIndex].value = value;

        // Regenerate the table to reflect changes
        const tbody = document.getElementById("factors-body");
        tbody.innerHTML = window.factorsData.map(window.createFactorRow).join("");
        
        // Re-initialize editable functionality
        makeHeadersEditable();
        makeTextCellsEditable();
        addRangeHandleEditing();

        // Save changes and close popover
        saveDataToStorage();
        closeRangePopover();
        showRangeUpdateNotification();
      };

      // Table 1: Show notification for range updates
      function showRangeUpdateNotification() {
        const notification = document.createElement('div');
        notification.textContent = 'Range settings updated successfully!';
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #28a745;
          color: white;
          padding: 10px 15px;
          border-radius: 4px;
          z-index: 1001;
          font-size: 14px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    </script>

    <section class="bg-white shadow-md rounded-lg p-8">
      <h2 class="text-sm font-normal mb-6 pb-2 border-b border-gray-300">Current readings on the key drivers of Equities for investors to consider, with arrows representing the recent trend:</h2>
      <div class="overflow-x-auto">
        <table class="w-full factors-table">
          <thead>
            <tr>
              <th rowspan="2" class="align-middle">Factor</th>
              <th class="align-middle">Implication for Equities</th>
              <th rowspan="2" class="align-middle">CIO View</th>
            </tr>
            <tr>
              <th class="text-xs">
                <div class="flex justify-between px-4">
                  <span>Negative</span>
                  <span>Neutral</span>
                  <span>Positive</span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="factors-body"></tbody>
        </table>
      </div>
      <div class="mt-4 text-xs text-gray-600">
        <p>2 of 12 August 2025 – CIO Viewpoint</p>
      </div>
    </section>
  </main>

  <!-- Table 2: CIO Asset Class Views with Weight Indicators -->
  <main class="max-w-7xl mx-auto mt-8 px-4">
    <!-- Table 2 Specific Styles -->
    <style>
      /* Weight indicator styles for Table 2 */
      .weight-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        padding-top: 25px;
        padding-bottom: 10px;
        cursor: pointer;
      }

      .weight-dot {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #666;
        cursor: pointer;
        position: relative;
      }

      .weight-dot.filled {
        border-color: #333;
      }

      .weight-dot.empty {
        background-color: #d3d3d3;
        border-color: #d3d3d3;
        width: 12px;
        height: 12px;
      }

      /* Weight dot colors based on position */
      .weight-dot.filled.overweight { background-color: #4CAF50; } /* Green */
      .weight-dot.filled.neutral { background-color: #FFC107; } /* Yellow */
      .weight-dot.filled.underweight { background-color: #ef4444; } /* Red */

      /* Hover effects for weight dots */
      .weight-dot:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
      }

      .weight-dot.empty:hover { border-color: #666; }
      .weight-dot.filled.overweight:hover { border-color: #2E7D32; }
      .weight-dot.filled.neutral:hover { border-color: #F57F17; }
      .weight-dot.filled.underweight:hover { border-color: #E65100; }

      /* Hidden weight indicators (when position is -1) */
      .weight-indicator.hidden {
        display: none;
      }
    </style>

    <!-- Table 2 Specific JavaScript Functions -->
    <script>
      // Table 2: Create asset class row with weight indicators
      window.createAssetClassRow = function(item) {
        // Determine if row should have separation borders
        const rowClass = item.separate === 1 ? ' class="separated-row"' : '';
        
        // If position is -1, hide all dots
        if (item.position === -1) {
          const weightIndicator = `
            <div class="weight-indicator hidden">
              <!-- No dots displayed when position is -1 -->
            </div>
          `;

          return `
            <tr${rowClass}>
              <td>${item.assetClass}</td>
              <td>${weightIndicator}</td>
              <td>${item.comments}</td>
            </tr>
          `;
        }

        // Create weight indicator dots for normal positions
        const totalDots = 5;
        let dotsHtml = '';
        
        for (let i = 1; i <= totalDots; i++) {
          let dotClass = 'weight-dot';
          
          if (i === item.position) {
            // Only the selected position gets color
            if (i <= 2) {
              dotClass += ' filled underweight'; // Red for positions 1-2
            } else if (i === 3) {
              dotClass += ' filled neutral'; // Yellow for position 3
            } else {
              dotClass += ' filled overweight'; // Green for positions 4-5
            }
          } else {
            dotClass += ' empty'; // All other dots are empty/gray
          }
          
          dotsHtml += `<div class="${dotClass}" data-position="${i}"></div>`;
        }

        const weightIndicator = `
          <div class="weight-indicator">
            ${dotsHtml}
          </div>
        `;

        return `
          <tr${rowClass}>
            <td>${item.assetClass}</td>
            <td>${weightIndicator}</td>
            <td>${item.comments}</td>
          </tr>
        `;
      };

      // Table 2: Weight indicator editing functionality
      function addTable2WeightIndicatorEditing() {
        const weightIndicators = document.querySelectorAll('#cio-view-body .weight-indicator');
        weightIndicators.forEach((indicator, index) => {
          // Single click for position selection (Table 2 only)
          indicator.addEventListener('click', function(e) {
            const dots = this.querySelectorAll('.weight-dot');
            const clickedDot = e.target.closest('.weight-dot');
            
            if (!clickedDot) return;
            
            const dotIndex = parseInt(clickedDot.getAttribute('data-position'));
            
            // Update the visual state - only the clicked dot gets color
            dots.forEach((dot, i) => {
              const dotPosition = parseInt(dot.getAttribute('data-position'));
              
              if (dotPosition === dotIndex) {
                // Only the selected position gets color
                if (dotIndex <= 2) {
                  dot.className = 'weight-dot filled underweight';
                } else if (dotIndex === 3) {
                  dot.className = 'weight-dot filled neutral';
                } else {
                  dot.className = 'weight-dot filled overweight';
                }
              } else {
                dot.className = 'weight-dot empty';
              }
            });
            
            // Update the data
            const row = this.closest('tr');
            const tbody = row.parentElement;
            const rowIndex = Array.from(tbody.children).indexOf(row);
            
            if (window.cioViewData && window.cioViewData[rowIndex]) {
              window.cioViewData[rowIndex].position = dotIndex;
              
              // Update weight based on position
              if (dotIndex <= 2) {
                window.cioViewData[rowIndex].weight = 'underweight';
              } else if (dotIndex === 3) {
                window.cioViewData[rowIndex].weight = 'neutral';
              } else {
                window.cioViewData[rowIndex].weight = 'overweight';
              }
              
              // Ensure fields exist
              if (window.cioViewData[rowIndex].separate === undefined) {
                window.cioViewData[rowIndex].separate = 0;
              }
              if (window.cioViewData[rowIndex].trend === undefined) {
                window.cioViewData[rowIndex].trend = 0;
              }
              
              saveDataToStorage();
              showWeightUpdateNotification();
            }
          });

          // Double click for weight editing or hiding dots
          indicator.addEventListener('dblclick', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const clickedDot = e.target.closest('.weight-dot');
            const row = this.closest('tr');
            const tbody = row.parentElement;
            const rowIndex = Array.from(tbody.children).indexOf(row);
            
            if (clickedDot && clickedDot.classList.contains('filled')) {
              // Open weight edit popover for filled dots
              if (window.cioViewData && window.cioViewData[rowIndex]) {
                showWeightEditPopover(clickedDot, window.cioViewData[rowIndex], rowIndex, 'cio-view');
              }
            } else {
              // Double-click on empty area - hide all dots (set position to -1)
              if (window.cioViewData && window.cioViewData[rowIndex]) {
                window.cioViewData[rowIndex].position = -1;
                window.cioViewData[rowIndex].weight = 'none';
                
                // Ensure fields exist
                if (window.cioViewData[rowIndex].separate === undefined) {
                  window.cioViewData[rowIndex].separate = 0;
                }
                if (window.cioViewData[rowIndex].trend === undefined) {
                  window.cioViewData[rowIndex].trend = 0;
                }
                
                // Regenerate Table 2
                const cioTbody = document.getElementById("cio-view-body");
                cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
                
                // Re-initialize functionality
                makeHeadersEditable();
                makeTextCellsEditable();
                addTable2WeightIndicatorEditing();
                
                saveDataToStorage();
                showWeightUpdateNotification();
              }
            }
          });
        });
      }

      // Table 2: Show weight update notification
      function showWeightUpdateNotification() {
        const notification = document.createElement('div');
        notification.textContent = 'Weight updated successfully!';
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          background: #28a745;
          color: white;
          padding: 10px 15px;
          border-radius: 4px;
          z-index: 1001;
          font-size: 14px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    </script>

    <section class="bg-white shadow-md rounded-lg p-8">
      <h2 class="text-sm font-normal mb-6 pb-2 border-b border-gray-300">Current CIO views on asset classes with weight recommendations:</h2>
      <div class="overflow-x-auto">
        <table class="w-full factors-table">
          <thead>
            <tr>
              <th rowspan="2" class="align-middle">Asset Class</th>
              <th class="align-middle">CIO View</th>
              <th rowspan="2" class="align-middle">Comments</th>
            </tr>
            <tr>
              <th class="text-xs">
                <div class="flex justify-between px-4">
                  <span>Underweight</span>
                  <span>Neutral</span>
                  <span>Overweight</span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="cio-view-body"></tbody>
        </table>
      </div>
      <div class="mt-4 text-xs text-gray-600">
        <p>*Asia Pac ex-Japan refers to the geographic area surrounding the Pacific Ocean.</p>
      </div>
    </section>
  </main>

  <!-- Table 3: Additional CIO Views with Weight Indicators and Trend Triangles -->
  <main class="max-w-7xl mx-auto mt-8 px-4">
    <!-- Table 3 Specific Styles -->
    <style>
      /* Trend triangles for Table 3 weight indicators */
      .trend-triangle {
        position: absolute;
        width: 0;
        height: 0;
        z-index: 10;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .trend-triangle:hover {
        transform: translateX(-50%) scale(1.1);
        filter: brightness(1.2);
      }

      .trend-triangle.left {
        border-left: 20px solid #ef4444;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        left: 100%;
        top: -6px;
        transform: translateX(-50%);
      }

      .trend-triangle.right {
        border-right: 20px solid #ef4444;
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
        top: -6px;
        transform: translateX(-50%);
      }

      /* Table 3 trend row highlights */
      .trend-row-up {
        background-color: rgba(239, 68, 68, 0.2) !important;
      }

      .trend-row-down {
        background-color: rgba(239, 68, 68, 0.2) !important;
      }

      .trend-row-up:hover,
      .trend-row-down:hover {
        background-color: rgba(239, 68, 68, 0.3) !important;
      }

      /* Table 3 rows are clickable */
      #table3-view-body tr {
        cursor: pointer;
      }

      #table3-view-body tr:hover {
        background-color: #f8f9fa !important;
      }
    </style>

    <!-- Table 3 Specific JavaScript Functions -->
    <script>
      // Table 3: Enhanced createAssetClassRow with trend triangles
      window.createTable3sectorRow = function(item) {
        // Determine if row should have separation borders
        let rowClass = item.separate === 1 ? 'separated-row' : '';
        
        // Add trend border class if there's a trend
        if (item.trend === 1) {
          rowClass += ' trend-row-up';
        } else if (item.trend === -1) {
          rowClass += ' trend-row-down';
        }
        
        // Add class attribute if there are any classes
        const classAttr = rowClass ? ` class="${rowClass.trim()}"` : '';
        
        // If position is -1, hide all dots
        if (item.position === -1) {
          const weightIndicator = `
            <div class="weight-indicator hidden">
              <!-- No dots displayed when position is -1 -->
            </div>
          `;

          return `
            <tr${classAttr}>
              <td>${item.sector}</td>
              <td>${weightIndicator}</td>
              <td>${item.comments}</td>
            </tr>
          `;
        }

        // Create weight indicator dots for normal positions
        const totalDots = 5;
        let dotsHtml = '';
        
        for (let i = 1; i <= totalDots; i++) {
          let dotClass = 'weight-dot';
          let triangleHtml = '';
          
          if (i === item.position) {
            // Only the selected position gets color
            if (i <= 2) {
              dotClass += ' filled underweight'; // Red for positions 1-2
            } else if (i === 3) {
              dotClass += ' filled neutral'; // Yellow for position 3
            } else {
              dotClass += ' filled overweight'; // Green for positions 4-5
            }
          } else {
            dotClass += ' empty'; // All other dots are empty/gray
          }
          
          // Add trend triangle based on trend value and position
          if (item.trend !== undefined && item.trend !== 0 && item.position !== -1) {
            if (item.trend === 1 && i === (item.position - 1) && i >= 1) {
              // Show upward trend triangle on the dot to the LEFT of the selected position
              triangleHtml = '<div class="trend-triangle left"></div>';
            } else if (item.trend === -1 && i === (item.position + 1) && i <= 5) {
              // Show downward trend triangle on the dot to the RIGHT of the selected position  
              triangleHtml = '<div class="trend-triangle right"></div>';
            }
          }
          
          dotsHtml += `<div class="${dotClass}" data-position="${i}">${triangleHtml}</div>`;
        }

        const weightIndicator = `
          <div class="weight-indicator">
            ${dotsHtml}
          </div>
        `;

        return `
          <tr${classAttr}>
            <td>${item.sector}</td>
            <td>${weightIndicator}</td>
            <td>${item.comments}</td>
          </tr>
        `;
      };

      // Table 3: Weight indicator editing functionality (double-click only)
      function addTable3WeightIndicatorEditing() {
        const weightIndicators = document.querySelectorAll('#table3-view-body .weight-indicator');
        weightIndicators.forEach((indicator, index) => {
          // Double click for editing
          indicator.addEventListener('dblclick', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const clickedTriangle = e.target.closest('.trend-triangle');
            const clickedDot = e.target.closest('.weight-dot');
            
            const row = this.closest('tr');
            const tbody = row.parentElement;
            const rowIndex = Array.from(tbody.children).indexOf(row);
            
            if (clickedTriangle) {
              // Handle trend triangle double-click
              showTrendEditPopover(clickedTriangle, window.table3ViewData[rowIndex], rowIndex, 'table3');
              return;
            } else if (clickedDot && clickedDot.classList.contains('filled')) {
              // Handle weight dot double-click for filled dots
              if (window.table3ViewData && window.table3ViewData[rowIndex]) {
                showWeightEditPopover(clickedDot, window.table3ViewData[rowIndex], rowIndex, 'table3');
              }
              return;
            } else {
              // Double-click on empty area - open popover
              if (window.table3ViewData && window.table3ViewData[rowIndex]) {
                showWeightEditPopover(this, window.table3ViewData[rowIndex], rowIndex, 'table3');
              }
            }
          });
        });
      }

      // Table 3: Row double-click functionality
      function addTable3RowEditing() {
        const table3Rows = document.querySelectorAll('#table3-view-body tr');
        table3Rows.forEach((row, index) => {
          row.addEventListener('dblclick', function(e) {
            // Prevent if already editing text or if clicking on an input
            if (e.target.tagName === 'INPUT' || e.target.closest('input')) {
              return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const tbody = this.parentElement;
            const rowIndex = Array.from(tbody.children).indexOf(this);
            
            if (window.table3ViewData && window.table3ViewData[rowIndex]) {
              // Open weight edit popover for this row
              const weightIndicator = this.querySelector('.weight-indicator');
              if (weightIndicator) {
                showWeightEditPopover(weightIndicator, window.table3ViewData[rowIndex], rowIndex, 'table3');
              } else {
                console.error('Weight indicator not found for Table 3 row:', rowIndex);
              }
            } else {
              console.error('Table 3 data not found for row:', rowIndex, 'Data:', window.table3ViewData);
            }
          });
          
          // Add visual feedback
          row.style.cursor = 'pointer';
          row.title = 'Double-click to edit weight settings';
        });
      }

      // Table 3: Show trend edit popover
      function showTrendEditPopover(triangle, data, rowIndex, tableType) {
        // Remove existing popover if any
        const existingPopover = document.querySelector('.trend-edit-popover');
        if (existingPopover) {
          existingPopover.remove();
        }

        // Create popover
        const popover = document.createElement('div');
        popover.className = 'trend-edit-popover';
        popover.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 20px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 1000;
          min-width: 220px;
          font-size: 14px;
        `;

        // Create form content
        popover.innerHTML = `
          <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">Edit Trend Direction</h3>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Trend Direction:</label>
            <select id="popover-trend-direction" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="0" ${data.trend === 0 ? 'selected' : ''}>No Trend</option>
              <option value="1" ${data.trend === 1 ? 'selected' : ''}>Upward Trend (→)</option>
              <option value="-1" ${data.trend === -1 ? 'selected' : ''}>Downward Trend (←)</option>
            </select>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              Trend triangles show direction of movement relative to current position
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeTrendPopover()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button onclick="saveTrendChanges(${rowIndex}, '${tableType}')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
          </div>
        `;

        document.body.appendChild(popover);
        window.currentTrendPopover = popover;

        // Close popover when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeTrendPopoverOnOutsideClick);
        }, 100);
      }

      // Table 3: Trend popover utility functions
      function closeTrendPopoverOnOutsideClick(e) {
        const popover = document.querySelector('.trend-edit-popover');
        if (popover && !popover.contains(e.target)) {
          closeTrendPopover();
        }
      }

      window.closeTrendPopover = function() {
        const popover = document.querySelector('.trend-edit-popover');
        if (popover) {
          popover.remove();
          document.removeEventListener('click', closeTrendPopoverOnOutsideClick);
        }
      };

      window.saveTrendChanges = function(rowIndex, tableType) {
        const trendValue = parseInt(document.getElementById('popover-trend-direction').value);

        // Update the data
        if (tableType === 'table3' && window.table3ViewData && window.table3ViewData[rowIndex]) {
          window.table3ViewData[rowIndex].trend = trendValue;
          
          // Regenerate Table 3 to reflect changes
          const table3Tbody = document.getElementById("table3-view-body");
          table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
          
          // Re-initialize editable functionality
          makeHeadersEditable();
          makeTextCellsEditable();
          addTable3WeightIndicatorEditing();
          addTable3RowEditing();
          
          console.log(`Updated trend for Table 3 row ${rowIndex} to ${trendValue}`);
        }

        // Save changes
        saveDataToStorage();
        closeTrendPopover();
        showTrendUpdateNotification();
      };

      // Table 3: Show trend update notification
      function showTrendUpdateNotification() {
        const notification = document.createElement('div');
        notification.textContent = 'Trend direction updated successfully!';
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          background: #28a745;
          color: white;
          padding: 10px 15px;
          border-radius: 4px;
          z-index: 1001;
          font-size: 14px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      }
    </script>

    <section class="bg-white shadow-md rounded-lg p-8">
      <h2 class="text-sm font-normal mb-6 pb-2 border-b border-gray-300">Additional CIO views on asset classes with weight recommendations:</h2>
      <div class="overflow-x-auto">
        <table class="w-full factors-table">
          <thead>
            <tr>
              <th rowspan="2" class="align-middle">Sector</th>
              <th class="align-middle">CIO View</th>
              <th rowspan="2" class="align-middle">Comments</th>
            </tr>
            <tr>
              <th class="text-xs">
                <div class="flex justify-between px-4">
                  <span>Underweight</span>
                  <span>Neutral</span>
                  <span>Overweight</span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="table3-view-body"></tbody>
        </table>
      </div>
      <div class="mt-4 text-xs text-gray-600">
        <p>*This table represents additional asset class considerations for portfolio construction.</p>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="text-center text-gray-500 text-sm py-4 mt-10 border-t">
    Source: Chief Investment Office | CIO Viewpoint © 2025
  </footer>

  <!-- Shared Weight Edit Popover JavaScript -->
  <script>
    // Shared weight edit popover function used by Table 2 and Table 3
    function showWeightEditPopover(element, data, rowIndex, tableType) {
      // Validate data before proceeding
      if (!data) {
        console.error('No data provided to showWeightEditPopover for row:', rowIndex);
        return;
      }

      // Remove existing popover if any
      const existingPopover = document.querySelector('.weight-edit-popover');
      if (existingPopover) {
        existingPopover.remove();
      }

      // Create popover
      const popover = document.createElement('div');
      popover.className = 'weight-edit-popover';
      popover.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 250px;
        font-size: 14px;
      `;

      // Ensure data properties exist with defaults
      const position = data.position !== undefined ? data.position : 3;
      const separate = data.separate !== undefined ? data.separate : 0;
      const trend = data.trend !== undefined ? data.trend : 0;

      // Create form content
      popover.innerHTML = `
        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">Edit Weight Position</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Position:</label>
          <select id="popover-weight-position" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="-1" ${position === -1 ? 'selected' : ''}>Hidden (No Dots)</option>
            <option value="1" ${position === 1 ? 'selected' : ''}>Position 1 (Strong Underweight)</option>
            <option value="2" ${position === 2 ? 'selected' : ''}>Position 2 (Underweight)</option>
            <option value="3" ${position === 3 ? 'selected' : ''}>Position 3 (Neutral)</option>
            <option value="4" ${position === 4 ? 'selected' : ''}>Position 4 (Overweight)</option>
            <option value="5" ${position === 5 ? 'selected' : ''}>Position 5 (Strong Overweight)</option>
          </select>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Separate Row:</label>
          <select id="popover-separate-row" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="0" ${separate === 0 ? 'selected' : ''}>Normal Row</option>
            <option value="1" ${separate === 1 ? 'selected' : ''}>Separated Row (with borders)</option>
          </select>
        </div>
        
        ${tableType === 'table3' ? `
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Trend Direction:</label>
          <select id="popover-trend-direction" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="0" ${trend === 0 ? 'selected' : ''}>No Trend</option>
            <option value="1" ${trend === 1 ? 'selected' : ''}>Upward Trend (→)</option>
            <option value="-1" ${trend === -1 ? 'selected' : ''}>Downward Trend (←)</option>
          </select>
        </div>
        ` : ''}
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeWeightPopover()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button onclick="saveWeightChanges(${rowIndex}, '${tableType}')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
        </div>
      `;

      document.body.appendChild(popover);
      window.currentWeightPopover = popover;

      // Close popover when clicking outside
      setTimeout(() => {
        document.addEventListener('click', closeWeightPopoverOnOutsideClick);
      }, 100);
    }

    // Shared weight popover utility functions
    function closeWeightPopoverOnOutsideClick(e) {
      const popover = document.querySelector('.weight-edit-popover');
      if (popover && !popover.contains(e.target)) {
        closeWeightPopover();
      }
    }

    window.closeWeightPopover = function() {
      const popover = document.querySelector('.weight-edit-popover');
      if (popover) {
        popover.remove();
        document.removeEventListener('click', closeWeightPopoverOnOutsideClick);
      }
    };

    window.saveWeightChanges = function(rowIndex, tableType) {
      const position = parseInt(document.getElementById('popover-weight-position').value);
      const separate = parseInt(document.getElementById('popover-separate-row').value);
      
      let trend = 0;
      if (tableType === 'table3') {
        trend = parseInt(document.getElementById('popover-trend-direction').value);
      }

      // Update the data based on table type
      let targetData = null;
      let targetTbodyId = null;
      
      if (tableType === 'cio-view') {
        targetData = window.cioViewData;
        targetTbodyId = 'cio-view-body';
      } else if (tableType === 'table3') {
        targetData = window.table3ViewData;
        targetTbodyId = 'table3-view-body';
      }
      
      if (targetData && targetData[rowIndex]) {
        targetData[rowIndex].position = position;
        targetData[rowIndex].separate = separate;
        
        if (tableType === 'table3') {
          targetData[rowIndex].trend = trend;
        }
        
        // Update weight based on position
        if (position === -1) {
          targetData[rowIndex].weight = 'none';
        } else if (position <= 2) {
          targetData[rowIndex].weight = 'underweight';
        } else if (position === 3) {
          targetData[rowIndex].weight = 'neutral';
        } else {
          targetData[rowIndex].weight = 'overweight';
        }
        
        // Regenerate the appropriate table
        if (targetTbodyId === 'cio-view-body') {
          const cioTbody = document.getElementById("cio-view-body");
          cioTbody.innerHTML = window.cioViewData.map(window.createsectorRow).join("");
          // Re-initialize Table 2 functionality
          makeHeadersEditable();
          makeTextCellsEditable();
          addTable2WeightIndicatorEditing();
        } else if (targetTbodyId === 'table3-view-body') {
          const table3Tbody = document.getElementById("table3-view-body");
          table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
          // Re-initialize Table 3 functionality
          makeHeadersEditable();
          makeTextCellsEditable();
          addTable3WeightIndicatorEditing();
          addTable3RowEditing();
        }
        
        console.log(`Updated weight settings for ${tableType} row ${rowIndex}`);
      }

      // Save changes
      saveDataToStorage();
      closeWeightPopover();
      showWeightUpdateNotification();
    };
  </script>

  <!-- JS Modules -->
  <script>
    // Component.js functionality
    window.createFactorRow = function(item) {
      // Create SVG arrow based on trend
      let trendArrow = '';
      const svgArrow = `<svg width="28" height="21" viewBox="0 0 122.88 108.06" xmlns="http://www.w3.org/2000/svg">
        <path d="M58.94,24.28a14.27,14.27,0,0,1,20.35-20l39.49,40.16a14.28,14.28,0,0,1,0,20L80.09,103.79a14.27,14.27,0,1,1-20.35-20L74.82,68.41l-60.67-.29a14.27,14.27,0,0,1,.24-28.54l59.85.28L58.94,24.28Z" fill="currentColor"/>
      </svg>`;
      
      switch(item.trend) {
        case 'up':
          trendArrow = `<span class="svg-arrow right">${svgArrow}</span>`;
          break;
        case 'down':
          trendArrow = `<span class="svg-arrow left">${svgArrow}</span>`;
          break;
        case 'neutral':
        default:
          trendArrow = '';
          break;
      }

      // Determine handle color class based on implication
      let handleColorClass = '';
      switch(item.implication.toLowerCase()) {
        case 'positive':
          handleColorClass = 'positive';
          break;
        case 'neutral':
          handleColorClass = 'neutral';
          break;
        case 'negative':
          handleColorClass = 'negative';
          break;
      }

      // Calculate position based on value (0-100) as percentage
      // Constrain position to prevent handle overflow (10px handle radius)
      const rawPosition = Math.min(Math.max(item.value, 0), 100);
      const constrainedPosition = Math.min(Math.max(rawPosition, 3), 97);
      
      // Create the range slider visualization
      const rangeSlider = `
        <div class="range-slider">
          <div class="range-track">
            <div class="range-thumb" style="left: ${constrainedPosition}%;">
              ${trendArrow}
              <div class="range-handle ${handleColorClass}"></div>
            </div>
          </div>
        </div>
      `;

      return `
        <tr>
          <td>${item.factor}</td>
          <td>${rangeSlider}</td>
          <td>${item.cioView}</td>
        </tr>
      `;
    };

    // CIO View table functionality
    window.createsectorRow = function(item) {
      // Determine if row should have separation borders
      const rowClass = item.separate === 1 ? ' class="separated-row"' : '';
      
      // If position is -1, hide all dots
      if (item.position === -1) {
        const weightIndicator = `
          <div class="weight-indicator hidden">
            <!-- No dots displayed when position is -1 -->
          </div>
        `;

        return `
          <tr${rowClass}>
            <td>${item.sector}</td>
            <td>${weightIndicator}</td>
            <td>${item.comments}</td>
          </tr>
        `;
      }

      // Create weight indicator dots for normal positions
      const totalDots = 5;
      let dotsHtml = '';
      
      for (let i = 1; i <= totalDots; i++) {
        let dotClass = 'weight-dot';
        let triangleHtml = '';
        
        if (i === item.position) {
          // Only the selected position gets color
          if (i <= 2) {
            dotClass += ' filled underweight'; // Red for positions 1-2
          } else if (i === 3) {
            dotClass += ' filled neutral'; // Yellow for position 3
          } else {
            dotClass += ' filled overweight'; // Green for positions 4-5
          }
        } else {
          dotClass += ' empty'; // All other dots are empty/gray
        }
        
        // Add trend triangle based on trend value and position
        if (item.trend !== undefined && item.trend !== 0 && item.position !== -1) {
          if (item.trend === 1 && i === (item.position - 1) && i >= 1) {
            // Show upward trend triangle on the dot to the LEFT of the selected position
            triangleHtml = '<div class="trend-triangle left"></div>';
          } else if (item.trend === -1 && i === (item.position + 1) && i <= 5) {
            // Show downward trend triangle on the dot to the RIGHT of the selected position  
            triangleHtml = '<div class="trend-triangle right"></div>';
          }
        }
        
        dotsHtml += `<div class="${dotClass}" data-position="${i}">${triangleHtml}</div>`;
      }

      const weightIndicator = `
        <div class="weight-indicator">
          ${dotsHtml}
        </div>
      `;

      return `
        <tr${rowClass}>
          <td>${item.sector}</td>
          <td>${weightIndicator}</td>
          <td>${item.comments}</td>
        </tr>
      `;
    };

    // Load data from combined JSON file
    async function loadDataFromJSON() {
      try {
        // Load combined dashboard data
        const response = await fetch('./js/combined_dashboard_data.json');
        const data = await response.json();
        
        console.log('Combined data loaded:', data);
        
        // Set the global data from combined source
        window.headerData = data.equityFactors.headers;
        window.factorsData = data.equityFactors.factors;
        window.cioViewData = data.sectorViews.sectores;
        window.table3ViewData = data.table3Views.sectores;
        window.dashboardInfo = data.dashboardInfo;
        
        console.log('CIO View Data:', window.cioViewData);
        console.log('CIO View Data length:', window.cioViewData.length);
        console.log('Table 3 View Data:', window.table3ViewData);
        console.log('Table 3 View Data length:', window.table3ViewData.length);
        
        // Update page title and header
        document.title = data.dashboardInfo.title;
        document.querySelector('h1').textContent = data.dashboardInfo.title;
        
        // Update headers in the DOM for first table
        const headers = document.querySelectorAll('th:not(.text-xs)');
        if (headers[0]) headers[0].textContent = window.headerData.factorHeader;
        if (headers[1]) headers[1].textContent = window.headerData.implicationHeader;
        if (headers[2]) headers[2].textContent = window.headerData.cioViewHeader;
        
        // Update table subtitles
        const tableSubtitles = document.querySelectorAll('h2');
        if (tableSubtitles[0]) tableSubtitles[0].textContent = data.equityFactors.subtitle;
        if (tableSubtitles[1]) tableSubtitles[1].textContent = data.sectorViews.subtitle;
        if (tableSubtitles[2]) tableSubtitles[2].textContent = data.table3Views.subtitle;
        
        // Update footnotes
        const footnoteElements = document.querySelectorAll('.mt-4.text-xs.text-gray-600 p');
        if (footnoteElements[1] && data.sectorViews.footnote) {
          footnoteElements[1].textContent = data.sectorViews.footnote;
        }
        if (footnoteElements[2] && data.table3Views.footnote) {
          footnoteElements[2].textContent = data.table3Views.footnote;
        }
        
        // Generate first table with factors data
        const tbody = document.getElementById("factors-body");
        tbody.innerHTML = window.factorsData.map(window.createFactorRow).join("");
        console.log('Factors table populated');
        
        // Generate second table with CIO View data
        const cioTbody = document.getElementById("cio-view-body");
        if (window.cioViewData && window.cioViewData.length > 0) {
          console.log('Populating CIO View table with', window.cioViewData.length, 'items');
          cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
          console.log('CIO View table populated');
        } else {
          console.error('No CIO View data available');
        }

        // Generate third table with Table 3 View data
        const table3Tbody = document.getElementById("table3-view-body");
        if (window.table3ViewData && window.table3ViewData.length > 0) {
          console.log('Populating Table 3 View table with', window.table3ViewData.length, 'items');
          table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
          console.log('Table 3 View table populated');
        } else {
          console.error('No Table 3 View data available');
        }
        
        console.log('Combined dashboard data loaded successfully');
      } catch (error) {
        console.error('Error loading combined JSON data:', error);
        // Fallback to individual file loading
        await loadDataFromSeparateFiles();
      }
        
      // Initialize editable functionality for both tables
      makeEditable();
    }

    // Fallback function to load from separate files
    async function loadDataFromSeparateFiles() {
      try {
        // Load factors data
        const response = await fetch('./js/equity_dashboard_data.json');
        const data = await response.json();
        
        window.headerData = data.headers;
        window.factorsData = data.factors;
        
        const headers = document.querySelectorAll('th:not(.text-xs)');
        if (headers[0]) headers[0].textContent = window.headerData.factorHeader;
        if (headers[1]) headers[1].textContent = window.headerData.implicationHeader;
        if (headers[2]) headers[2].textContent = window.headerData.cioViewHeader;
        
        const tbody = document.getElementById("factors-body");
        tbody.innerHTML = window.factorsData.map(window.createFactorRow).join("");
        
        console.log('Factors data loaded from separate file');
      } catch (error) {
        console.error('Error loading factors JSON data:', error);
        initializeWithFallbackData();
      }

      try {
        // Load CIO View data
        const cioResponse = await fetch('./js/cio_view_data.json');
        const cioData = await cioResponse.json();
        
        window.cioViewData = cioData.sectores;
        
        const cioTbody = document.getElementById("cio-view-body");
        cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
        
        console.log('CIO View data loaded from separate file');
      } catch (error) {
        console.error('Error loading CIO View JSON data:', error);
        initializeCIOViewFallback();
      }

      // Initialize Table 3 with fallback data
      try {
        initializeTable3ViewFallback();
      } catch (error) {
        console.error('Error initializing Table 3 View data:', error);
      }
    }

    // Fallback initialization
    function initializeWithFallbackData() {
      // Initialize with default header data
      window.headerData = {
        factorHeader: "Factor",
        implicationHeader: "Implication for Equities", 
        cioViewHeader: "CIO View"
      };
      
      // Initialize with minimal fallback data if factorsData doesn't exist
      if (!window.factorsData) {
        window.factorsData = [
          {
            factor: "Sample Factor",
            implication: "Neutral",
            trend: "neutral",
            value: 50,
            cioView: "Please load data from JSON file or import your data."
          }
        ];
      }
      
      // Generate table with existing data
      const tbody = document.getElementById("factors-body");
      tbody.innerHTML = window.factorsData.map(window.createFactorRow).join("");
      
      // Initialize editable functionality
      makeEditable();
    }

    // CIO View fallback initialization
    function initializeCIOViewFallback() {
      window.cioViewData = [
        {
          sector: "Sample Asset Class",
          weight: "neutral",
          position: 3,
          separate: 0,
          comments: "Please ensure CIO View data file is available."
        }
      ];
      
      const cioTbody = document.getElementById("cio-view-body");
      cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
    }

    // Table 3 View fallback initialization
    function initializeTable3ViewFallback() {
      window.table3ViewData = [
        {
          sector: "Sample Additional Asset Class",
          weight: "neutral",
          position: 3,
          separate: 0,
          trend: 0,
          comments: "Please ensure Table 3 View data is available."
        }
      ];
      
      const table3Tbody = document.getElementById("table3-view-body");
      table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
    }

    // Store original header values for reference
    window.headerData = {
      factorHeader: "Factor",
      implicationHeader: "Implication for Equities", 
      cioViewHeader: "CIO View"
    };

    // Add editable functionality to all headers and data cells
    function makeEditable() {
      // Make specific header cells editable (excluding the sub-header with alignment labels)
      const editableHeaders = document.querySelectorAll('th:not(.text-xs)');
      editableHeaders.forEach((cell, index) => {
        cell.addEventListener('dblclick', function() {
          if (this.querySelector('input')) return; // Already editing
          
          const originalText = this.textContent.trim();
          const input = document.createElement('input');
          input.type = 'text';
          input.value = originalText;
          input.style.width = '100%';
          input.style.border = 'none';
          input.style.background = 'transparent';
          input.style.fontSize = 'inherit';
          input.style.fontWeight = 'inherit';
          input.style.textAlign = 'inherit';
          input.style.padding = '4px';
          
          this.innerHTML = '';
          this.appendChild(input);
          input.focus();
          input.select();
          
          const saveEdit = () => {
            const newValue = input.value || originalText;
            this.textContent = newValue;
            
            // Update header data based on column position
            if (index === 0) {
              window.headerData.factorHeader = newValue;
            } else if (index === 1) {
              window.headerData.implicationHeader = newValue;
            } else if (index === 2) {
              window.headerData.cioViewHeader = newValue;
            }
            
            // Save to localStorage
            saveDataToStorage();
          };
          
          input.addEventListener('blur', saveEdit);
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              saveEdit();
            }
            if (e.key === 'Escape') {
              this.textContent = originalText;
            }
          });
        });
      });
      
      // Make data cells editable (excluding range slider column and weight indicator column)
      const dataCells = document.querySelectorAll('tbody td:first-child, tbody td:last-child');
      dataCells.forEach((cell, index) => {
        cell.addEventListener('dblclick', function() {
          if (this.querySelector('input')) return; // Already editing
          
          const originalText = this.textContent.trim();
          const input = document.createElement('input');
          input.type = 'text';
          input.value = originalText;
          input.style.width = '100%';
          input.style.border = 'none';
          input.style.background = 'transparent';
          input.style.fontSize = 'inherit';
          input.style.fontWeight = 'inherit';
          input.style.textAlign = 'inherit';
          input.style.padding = '4px';
          
          this.innerHTML = '';
          this.appendChild(input);
          input.focus();
          input.select();
          
          const saveEdit = () => {
            const newValue = input.value || originalText;
            this.textContent = newValue;
            
            // Update the data array based on which table this cell belongs to
            const row = this.parentElement;
            const tbody = row.parentElement;
            const rowIndex = Array.from(tbody.children).indexOf(row);
            
            // Check if this is the factors table or CIO view table
            if (tbody.id === 'factors-body') {
              if (this === row.firstElementChild) {
                // Factor column
                window.factorsData[rowIndex].factor = newValue;
              } else if (this === row.lastElementChild) {
                // CIO View column for factors table
                window.factorsData[rowIndex].cioView = newValue;
              }
            } else if (tbody.id === 'cio-view-body') {
              if (this === row.firstElementChild) {
                // Asset Class column
                if (window.cioViewData && window.cioViewData[rowIndex]) {
                  window.cioViewData[rowIndex].sector = newValue;
                }
              } else if (this === row.lastElementChild) {
                // Comments column
                if (window.cioViewData && window.cioViewData[rowIndex]) {
                  window.cioViewData[rowIndex].comments = newValue;
                }
              }
            } else if (tbody.id === 'table3-view-body') {
              if (this === row.firstElementChild) {
                // Asset Class column for Table 3
                if (window.table3ViewData && window.table3ViewData[rowIndex]) {
                  window.table3ViewData[rowIndex].sector = newValue;
                }
              } else if (this === row.lastElementChild) {
                // Comments column for Table 3
                if (window.table3ViewData && window.table3ViewData[rowIndex]) {
                  window.table3ViewData[rowIndex].comments = newValue;
                }
              }
            }
            
            // Save to localStorage
            saveDataToStorage();
          };
          
          input.addEventListener('blur', saveEdit);
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              saveEdit();
            }
            if (e.key === 'Escape') {
              this.textContent = originalText;
            }
          });
        });
      });
      
      // Add double-click functionality to Table 3 rows for weight editing
      const table3Rows = document.querySelectorAll('#table3-view-body tr');
      table3Rows.forEach((row, index) => {
        row.addEventListener('dblclick', function(e) {
          // Prevent if already editing text or if clicking on an input
          if (e.target.tagName === 'INPUT' || e.target.closest('input')) {
            return;
          }
          
          e.preventDefault();
          e.stopPropagation();
          
          const tbody = this.parentElement;
          const rowIndex = Array.from(tbody.children).indexOf(this);
          
          if (window.table3ViewData && window.table3ViewData[rowIndex]) {
            // Open weight edit popover for this row
            const weightIndicator = this.querySelector('.weight-indicator');
            if (weightIndicator) {
              // Use the center of the weight indicator area for popover positioning
              showWeightEditPopover(weightIndicator, window.table3ViewData[rowIndex], rowIndex, 'table3');
            } else {
              console.error('Weight indicator not found for Table 3 row:', rowIndex);
            }
          } else {
            console.error('Table 3 data not found for row:', rowIndex, 'Data:', window.table3ViewData);
          }
        });
        
        // Add visual feedback for Table 3 rows to indicate they're clickable
        row.style.cursor = 'pointer';
        row.title = 'Double-click to edit weight settings';
      });
      
      // Add double-click functionality to range handles
      addRangeHandleEditing();

      // Add click functionality to weight indicators  
      addWeightIndicatorEditing();
    }

    // Function to add weight indicator editing
    function addWeightIndicatorEditing() {
      const weightIndicators = document.querySelectorAll('.weight-indicator');
      weightIndicators.forEach((indicator, index) => {
        // Single click for position selection (only for Table 2 - CIO view)
        indicator.addEventListener('click', function(e) {
          const row = this.closest('tr');
          const tbody = row.parentElement;
          
          // Only allow single-click editing for Table 2 (cio-view-body), not Table 3
          if (tbody.id !== 'cio-view-body') {
            return;
          }
          
          const dots = this.querySelectorAll('.weight-dot');
          const clickedDot = e.target.closest('.weight-dot');
          
          if (!clickedDot) return;
          
          const dotIndex = parseInt(clickedDot.getAttribute('data-position'));
          
          // Update the visual state - only the clicked dot gets color
          dots.forEach((dot, i) => {
            const dotPosition = parseInt(dot.getAttribute('data-position'));
            
            if (dotPosition === dotIndex) {
              // Only the selected position gets color
              if (dotIndex <= 2) {
                dot.className = 'weight-dot filled underweight'; // Red for positions 1-2
              } else if (dotIndex === 3) {
                dot.className = 'weight-dot filled neutral'; // Yellow for position 3
              } else {
                dot.className = 'weight-dot filled overweight'; // Green for positions 4-5
              }
            } else {
              dot.className = 'weight-dot empty'; // All other dots are empty
            }
          });
          
          // Update the data
          const rowIndex = Array.from(tbody.children).indexOf(row);
          
          let targetData = null;
          if (tbody.id === 'cio-view-body') {
            targetData = window.cioViewData;
          }
          
          if (targetData && targetData[rowIndex]) {
            targetData[rowIndex].position = dotIndex;
            
            // Update weight based on position
            if (dotIndex <= 2) {
              targetData[rowIndex].weight = 'underweight';
            } else if (dotIndex === 3) {
              targetData[rowIndex].weight = 'neutral';
            } else {
              targetData[rowIndex].weight = 'overweight';
            }
            
            // Ensure separate field exists (default to 0 if not present)
            if (targetData[rowIndex].separate === undefined) {
              targetData[rowIndex].separate = 0;
            }
            
            // Ensure trend field exists (default to 0 if not present)
            if (targetData[rowIndex].trend === undefined) {
              targetData[rowIndex].trend = 0;
            }
            
            saveDataToStorage();
            showWeightUpdateNotification();
          }
        });

        // Double click for trend editing on triangles and weight editing on dots
        indicator.addEventListener('dblclick', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const clickedTriangle = e.target.closest('.trend-triangle');
          const clickedDot = e.target.closest('.weight-dot');
          
          const row = this.closest('tr');
          const tbody = row.parentElement;
          const rowIndex = Array.from(tbody.children).indexOf(row);
          
          if (clickedTriangle) {
            // Handle trend triangle double-click for Table 3
            if (tbody.id === 'table3-view-body') {
              showTrendEditPopover(clickedTriangle, window.table3ViewData[rowIndex], rowIndex, 'table3');
              return;
            }
          } else if (clickedDot && clickedDot.classList.contains('filled')) {
            // Handle weight dot double-click for position/weight editing popover (only for filled dots)
            let targetData = null;
            let tableType = '';
            
            if (tbody.id === 'cio-view-body') {
              targetData = window.cioViewData;
              tableType = 'cio-view';
            } else if (tbody.id === 'table3-view-body') {
              targetData = window.table3ViewData;
              tableType = 'table3';
            }
            
            if (targetData && targetData[rowIndex]) {
              showWeightEditPopover(clickedDot, targetData[rowIndex], rowIndex, tableType);
            }
            return;
          } else {
            // Double-click on weight indicator area (not on specific dot or triangle)
            let targetData = null;
            let tableType = '';
            
            if (tbody.id === 'cio-view-body') {
              targetData = window.cioViewData;
              tableType = 'cio-view';
              
              // For Table 2 (CIO View), hide all dots (set position to -1)
              if (targetData && targetData[rowIndex]) {
                targetData[rowIndex].position = -1;
                targetData[rowIndex].weight = 'none';
                
                // Ensure separate field exists (default to 0 if not present)
                if (targetData[rowIndex].separate === undefined) {
                  targetData[rowIndex].separate = 0;
                }
                
                // Ensure trend field exists (default to 0 if not present)
                if (targetData[rowIndex].trend === undefined) {
                  targetData[rowIndex].trend = 0;
                }
                
                // Regenerate Table 2
                const cioTbody = document.getElementById("cio-view-body");
                cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
                
                // Re-initialize editable functionality
                makeEditable();
                
                saveDataToStorage();
                showWeightUpdateNotification();
              }
            } else if (tbody.id === 'table3-view-body') {
              targetData = window.table3ViewData;
              tableType = 'table3';
              
              // For Table 3, open the popover instead of hiding dots
              if (targetData && targetData[rowIndex]) {
                showWeightEditPopover(this, targetData[rowIndex], rowIndex, tableType);
              }
            }
          }
        });

        // Add double-click functionality to hide all dots (set position to -1)
        indicator.addEventListener('dblclick', function(e) {
          e.preventDefault();
          
          const row = this.closest('tr');
          const tbody = row.parentElement;
          const rowIndex = Array.from(tbody.children).indexOf(row);
          
          let targetData = null;
          let targetTbodyId = null;
          if (tbody.id === 'cio-view-body') {
            targetData = window.cioViewData;
            targetTbodyId = 'cio-view-body';
          } else if (tbody.id === 'table3-view-body') {
            targetData = window.table3ViewData;
            targetTbodyId = 'table3-view-body';
          }
          
          if (targetData && targetData[rowIndex]) {
            // Set position to -1 to hide all dots
            targetData[rowIndex].position = -1;
            targetData[rowIndex].weight = 'none';
            
            // Ensure separate field exists (default to 0 if not present)
            if (targetData[rowIndex].separate === undefined) {
              targetData[rowIndex].separate = 0;
            }
            
            // Ensure trend field exists (default to 0 if not present)
            if (targetData[rowIndex].trend === undefined) {
              targetData[rowIndex].trend = 0;
            }
            
            // Regenerate the appropriate table
            if (targetTbodyId === 'cio-view-body') {
              const cioTbody = document.getElementById("cio-view-body");
              cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
            } else if (targetTbodyId === 'table3-view-body') {
              const table3Tbody = document.getElementById("table3-view-body");
              table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
            }
            
            // Re-initialize editable functionality
            makeEditable();
            
            saveDataToStorage();
            showWeightUpdateNotification();
          }
        });
      });
    }

    // Show weight update notification
    function showWeightUpdateNotification() {
      const notification = document.createElement('div');
      notification.textContent = 'Weight updated successfully!';
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        z-index: 1001;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Function to add range handle editing functionality
    function addRangeHandleEditing() {
      const rangeHandles = document.querySelectorAll('.range-handle');
      rangeHandles.forEach((handle, index) => {
        handle.addEventListener('dblclick', function(e) {
          e.stopPropagation(); // Prevent event bubbling
          
          const row = this.closest('tr');
          const rowIndex = Array.from(row.parentElement.children).indexOf(row);
          const factorData = window.factorsData[rowIndex];
          
          showRangeEditPopover(this, factorData, rowIndex);
        });
        
        // Add cursor pointer to indicate it's clickable
        handle.style.cursor = 'pointer';
      });
    }

    // Function to show range edit popover
    function showRangeEditPopover(handle, factorData, rowIndex) {
      // Remove existing popover if any
      const existingPopover = document.querySelector('.range-edit-popover');
      if (existingPopover) {
        existingPopover.remove();
      }

      // Create popover
      const popover = document.createElement('div');
      popover.className = 'range-edit-popover';
      popover.style.cssText = `
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 250px;
        font-size: 14px;
      `;

      // Get handle position
      const handleRect = handle.getBoundingClientRect();
      popover.style.left = (handleRect.left + window.scrollX - 125) + 'px';
      popover.style.top = (handleRect.bottom + window.scrollY + 10) + 'px';

      // Create form content
      popover.innerHTML = `
        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">Edit Range Settings</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Implication:</label>
          <select id="popover-implication" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="positive" ${factorData.implication.toLowerCase() === 'positive' ? 'selected' : ''}>Positive</option>
            <option value="neutral" ${factorData.implication.toLowerCase() === 'neutral' ? 'selected' : ''}>Neutral</option>
            <option value="negative" ${factorData.implication.toLowerCase() === 'negative' ? 'selected' : ''}>Negative</option>
          </select>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Trend:</label>
          <select id="popover-trend" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="up" ${factorData.trend === 'up' ? 'selected' : ''}>Up</option>
            <option value="neutral" ${factorData.trend === 'neutral' ? 'selected' : ''}>Neutral</option>
            <option value="down" ${factorData.trend === 'down' ? 'selected' : ''}>Down</option>
          </select>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Value: <span id="value-display">${factorData.value}</span></label>
          <input type="range" id="popover-value" min="0" max="100" value="${factorData.value}" 
                 style="width: 100%; margin-bottom: 5px;"
                 oninput="document.getElementById('value-display').textContent = this.value">
          <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
            <span>0</span>
            <span>50</span>
            <span>100</span>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeRangePopover()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button onclick="saveRangeChanges(${rowIndex})" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
        </div>
      `;

      document.body.appendChild(popover);
      window.currentRangePopover = popover;

      // Close popover when clicking outside
      setTimeout(() => {
        document.addEventListener('click', closePopoverOnOutsideClick);
      }, 100);
    }

    // Function to show weight edit popover
    function showWeightEditPopover(element, data, rowIndex, tableType) {
      // Validate data before proceeding
      if (!data) {
        console.error('No data provided to showWeightEditPopover for row:', rowIndex);
        return;
      }

      // Remove existing popover if any
      const existingPopover = document.querySelector('.weight-edit-popover');
      if (existingPopover) {
        existingPopover.remove();
      }

      // Create popover
      const popover = document.createElement('div');
      popover.className = 'weight-edit-popover';
      popover.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 250px;
        font-size: 14px;
      `;

      // Ensure data properties exist with defaults
      const position = data.position !== undefined ? data.position : 3;
      const separate = data.separate !== undefined ? data.separate : 0;
      const trend = data.trend !== undefined ? data.trend : 0;

      // Create form content
      popover.innerHTML = `
        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">Edit Weight Position</h3>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Position:</label>
          <select id="popover-weight-position" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="-1" ${position === -1 ? 'selected' : ''}>Hidden (No Dots)</option>
            <option value="1" ${position === 1 ? 'selected' : ''}>Position 1 (Strong Underweight)</option>
            <option value="2" ${position === 2 ? 'selected' : ''}>Position 2 (Underweight)</option>
            <option value="3" ${position === 3 ? 'selected' : ''}>Position 3 (Neutral)</option>
            <option value="4" ${position === 4 ? 'selected' : ''}>Position 4 (Overweight)</option>
            <option value="5" ${position === 5 ? 'selected' : ''}>Position 5 (Strong Overweight)</option>
          </select>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Separate Row:</label>
          <select id="popover-separate-row" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="0" ${separate === 0 ? 'selected' : ''}>Normal Row</option>
            <option value="1" ${separate === 1 ? 'selected' : ''}>Separated Row (with borders)</option>
          </select>
        </div>
        
        ${tableType === 'table3' ? `
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Trend Direction:</label>
          <select id="popover-trend-direction" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="0" ${trend === 0 ? 'selected' : ''}>No Trend</option>
            <option value="1" ${trend === 1 ? 'selected' : ''}>Upward Trend (→)</option>
            <option value="-1" ${trend === -1 ? 'selected' : ''}>Downward Trend (←)</option>
          </select>
        </div>
        ` : ''}
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeWeightPopover()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button onclick="saveWeightChanges(${rowIndex}, '${tableType}')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
        </div>
      `;

      document.body.appendChild(popover);
      window.currentWeightPopover = popover;

      // Close popover when clicking outside
      setTimeout(() => {
        document.addEventListener('click', closeWeightPopoverOnOutsideClick);
      }, 100);
    }

    // Function to close weight popover when clicking outside
    function closeWeightPopoverOnOutsideClick(e) {
      const popover = document.querySelector('.weight-edit-popover');
      if (popover && !popover.contains(e.target)) {
        closeWeightPopover();
      }
    }

    // Function to close weight popover
    window.closeWeightPopover = function() {
      const popover = document.querySelector('.weight-edit-popover');
      if (popover) {
        popover.remove();
        document.removeEventListener('click', closeWeightPopoverOnOutsideClick);
      }
    };

    // Function to save weight changes
    window.saveWeightChanges = function(rowIndex, tableType) {
      const position = parseInt(document.getElementById('popover-weight-position').value);
      const separate = parseInt(document.getElementById('popover-separate-row').value);
      
      let trend = 0;
      if (tableType === 'table3') {
        trend = parseInt(document.getElementById('popover-trend-direction').value);
      }

      // Update the data based on table type
      let targetData = null;
      let targetTbodyId = null;
      
      if (tableType === 'cio-view') {
        targetData = window.cioViewData;
        targetTbodyId = 'cio-view-body';
      } else if (tableType === 'table3') {
        targetData = window.table3ViewData;
        targetTbodyId = 'table3-view-body';
      }
      
      if (targetData && targetData[rowIndex]) {
        targetData[rowIndex].position = position;
        targetData[rowIndex].separate = separate;
        
        if (tableType === 'table3') {
          targetData[rowIndex].trend = trend;
        }
        
        // Update weight based on position
        if (position === -1) {
          targetData[rowIndex].weight = 'none';
        } else if (position <= 2) {
          targetData[rowIndex].weight = 'underweight';
        } else if (position === 3) {
          targetData[rowIndex].weight = 'neutral';
        } else {
          targetData[rowIndex].weight = 'overweight';
        }
        
        // Regenerate the appropriate table
        if (targetTbodyId === 'cio-view-body') {
          const cioTbody = document.getElementById("cio-view-body");
          cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
        } else if (targetTbodyId === 'table3-view-body') {
          const table3Tbody = document.getElementById("table3-view-body");
          table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
        }
        
        // Re-initialize editable functionality
        makeEditable();
        
        console.log(`Updated weight settings for ${tableType} row ${rowIndex}`);
      }

      // Save changes
      saveDataToStorage();

      // Close popover
      closeWeightPopover();

      // Show success notification
      showWeightUpdateNotification();
    };

    // Function to show trend edit popover
    function showTrendEditPopover(triangle, data, rowIndex, tableType) {
      // Remove existing popover if any
      const existingPopover = document.querySelector('.trend-edit-popover');
      if (existingPopover) {
        existingPopover.remove();
      }

      // Create popover
      const popover = document.createElement('div');
      popover.className = 'trend-edit-popover';
      popover.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 220px;
        font-size: 14px;
      `;

      // Create form content
      popover.innerHTML = `
        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: bold;">Edit Trend Direction</h3>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">Trend Direction:</label>
          <select id="popover-trend-direction" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="0" ${data.trend === 0 ? 'selected' : ''}>No Trend</option>
            <option value="1" ${data.trend === 1 ? 'selected' : ''}>Upward Trend (→)</option>
            <option value="-1" ${data.trend === -1 ? 'selected' : ''}>Downward Trend (←)</option>
          </select>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Trend triangles show direction of movement relative to current position
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeTrendPopover()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
          <button onclick="saveTrendChanges(${rowIndex}, '${tableType}')" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
        </div>
      `;

      document.body.appendChild(popover);
      window.currentTrendPopover = popover;

      // Close popover when clicking outside
      setTimeout(() => {
        document.addEventListener('click', closeTrendPopoverOnOutsideClick);
      }, 100);
    }

    // Function to close trend popover when clicking outside
    function closeTrendPopoverOnOutsideClick(e) {
      const popover = document.querySelector('.trend-edit-popover');
      if (popover && !popover.contains(e.target)) {
        closeTrendPopover();
      }
    }

    // Function to close trend popover
    window.closeTrendPopover = function() {
      const popover = document.querySelector('.trend-edit-popover');
      if (popover) {
        popover.remove();
        document.removeEventListener('click', closeTrendPopoverOnOutsideClick);
      }
    };

    // Function to save trend changes
    window.saveTrendChanges = function(rowIndex, tableType) {
      const trendValue = parseInt(document.getElementById('popover-trend-direction').value);

      // Update the data based on table type
      if (tableType === 'table3' && window.table3ViewData && window.table3ViewData[rowIndex]) {
        window.table3ViewData[rowIndex].trend = trendValue;
        
        // Regenerate Table 3 to reflect changes
        const table3Tbody = document.getElementById("table3-view-body");
        table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
        
        // Re-initialize editable functionality
        makeEditable();
        
        console.log(`Updated trend for Table 3 row ${rowIndex} to ${trendValue}`);
      }

      // Save changes
      saveDataToStorage();

      // Close popover
      closeTrendPopover();

      // Show success notification
      showTrendUpdateNotification();
    };

    // Function to show trend update notification
    function showTrendUpdateNotification() {
      const notification = document.createElement('div');
      notification.textContent = 'Trend direction updated successfully!';
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        z-index: 1001;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Function to close range popover when clicking outside
    function closePopoverOnOutsideClick(e) {
      const popover = document.querySelector('.range-edit-popover');
      if (popover && !popover.contains(e.target)) {
        closeRangePopover();
      }
    }

    // Function to close range popover
    window.closeRangePopover = function() {
      const popover = document.querySelector('.range-edit-popover');
      if (popover) {
        popover.remove();
        document.removeEventListener('click', closePopoverOnOutsideClick);
      }
    };

    // Function to save range changes
    window.saveRangeChanges = function(rowIndex) {
      const implication = document.getElementById('popover-implication').value;
      const trend = document.getElementById('popover-trend').value;
      const value = parseInt(document.getElementById('popover-value').value);

      // Update the data
      window.factorsData[rowIndex].implication = implication.charAt(0).toUpperCase() + implication.slice(1);
      window.factorsData[rowIndex].trend = trend;
      window.factorsData[rowIndex].value = value;

      // Regenerate the table to reflect changes
      const tbody = document.getElementById("factors-body");
      tbody.innerHTML = window.factorsData.map(window.createFactorRow).join("");
      
      // Re-initialize editable functionality
      makeEditable();

      // Save changes
      saveDataToStorage();

      // Close popover
      closeRangePopover();

      // Show success notification
      showRangeUpdateNotification();
    };

    // Function to show range update notification
    function showRangeUpdateNotification() {
      const notification = document.createElement('div');
      notification.textContent = 'Range settings updated successfully!';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        z-index: 1001;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 3000);
    }

    // Initialize editable functionality
    makeEditable();

    // Functions to save and load data
    async function saveDataToJSON() {
      const combinedData = {
        dashboardInfo: window.dashboardInfo || {
          title: "CIO Viewpoint Dashboard",
          subtitle: "Comprehensive Investment Outlook",
          lastUpdated: new Date().toISOString(),
          version: "1.0"
        },
        equityFactors: {
          headers: window.headerData,
          subtitle: "Current readings on the key drivers of Equities for investors to consider, with arrows representing the recent trend:",
          factors: window.factorsData
        },
        assetClassViews: {
          headers: {
            assetClassHeader: "Asset Class",
            cioViewHeader: "CIO View",
            commentsHeader: "Comments"
          },
          subtitle: "Current CIO views on asset classes with weight recommendations:",
          footnote: "*Asia Pac ex-Japan refers to the geographic area surrounding the Pacific Ocean. The Asia Pac ex-Japan covers the western shores of North America and South America and the shores of Australia, eastern Asia and the islands of the Pacific.",
          assetClasses: window.cioViewData || []
        },
        table3Views: {
          headers: {
            assetClassHeader: "Asset Class",
            cioViewHeader: "CIO View",
            commentsHeader: "Comments"
          },
          subtitle: "Additional CIO views on asset classes with weight recommendations:",
          footnote: "*This table represents additional asset class considerations for portfolio construction.",
          assetClasses: window.table3ViewData || []
        }
      };
      
      // Update last modified timestamp
      combinedData.dashboardInfo.lastUpdated = new Date().toISOString();
      
      // Save to localStorage as backup
      localStorage.setItem('combinedDashboardData', JSON.stringify(combinedData, null, 2));
      
      // Also save individual sections for backward compatibility
      localStorage.setItem('equityDashboardData', JSON.stringify({
        headers: window.headerData,
        factors: window.factorsData,
        lastModified: new Date().toISOString()
      }, null, 2));
      
      localStorage.setItem('cioViewDashboardData', JSON.stringify({
        headers: combinedData.assetClassViews.headers,
        assetClasses: window.cioViewData || [],
        lastModified: new Date().toISOString()
      }, null, 2));
      
      localStorage.setItem('table3ViewDashboardData', JSON.stringify({
        headers: combinedData.table3Views.headers,
        assetClasses: window.table3ViewData || [],
        lastModified: new Date().toISOString()
      }, null, 2));
      
      // Automatically update the JSON file content and show notification
      console.log('Combined data updated in memory and localStorage');
      await updateCombinedJSONFileContent(combinedData);
      showSaveNotification();
    }

    async function updateCombinedJSONFileContent(data) {
      // Generate the updated JSON content for combined data
      const jsonContent = JSON.stringify(data, null, 2);
      
      console.log('Updated JSON content for combined_dashboard_data.json:');
      console.log(jsonContent);
      
      // Store the updated content for potential file replacement
      window.updatedCombinedJSONContent = jsonContent;
    }

    async function updateJSONFileContent(data) {
      // Generate the updated JSON content
      const jsonContent = JSON.stringify(data, null, 2);
      
      // Try to show the updated content in console for development
      console.log('Updated JSON content for equity_dashboard_data.json:');
      console.log(jsonContent);
      
      // Store the updated content for potential file replacement
      window.updatedJSONContent = jsonContent;
    }

    async function updateCIOViewJSONFileContent(data) {
      // Generate the updated JSON content for CIO View
      const jsonContent = JSON.stringify(data, null, 2);
      
      console.log('Updated JSON content for cio_view_data.json:');
      console.log(jsonContent);
      
      // Store the updated content for potential file replacement
      window.updatedCIOViewJSONContent = jsonContent;
    }

    function showSaveNotification() {
      // Create notification element
      const notification = document.createElement('div');
      notification.innerHTML = `
        <div>Data automatically updated!</div>
        <button onclick="showUpdatedJSON()" style="margin-top: 5px; padding: 2px 6px; background: white; color: #28a745; border: 1px solid white; border-radius: 2px; cursor: pointer; font-size: 12px;">View JSON</button>
      `;
      notification.style.cssText = `
        position: fixed;
        top: 60px;
        right: 10px;
        background: #28a745;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        z-index: 1001;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 5 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 5000);
    }

    // Function to show updated JSON content
    window.showUpdatedJSON = function() {
      // Check for combined JSON content first (current approach)
      let jsonContent = window.updatedCombinedJSONContent;
      let fileName = 'combined_dashboard_data.json';
      
      // Fallback to individual JSON content if combined not available
      if (!jsonContent && window.updatedJSONContent) {
        jsonContent = window.updatedJSONContent;
        fileName = 'equity_dashboard_data.json';
      }
      
      if (jsonContent) {
        // Create modal to show JSON content
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          z-index: 2000;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
          background: white;
          padding: 20px;
          border-radius: 8px;
          max-width: 80%;
          max-height: 80%;
          overflow: auto;
        `;
        
        content.innerHTML = `
          <h3 style="margin-top: 0;">Updated JSON Content</h3>
          <p style="font-size: 14px; color: #666;">Copy this content and replace the content in js/${fileName}</p>
          <textarea readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 12px; border: 1px solid #ddd; padding: 10px;">${jsonContent}</textarea>
          <div style="margin-top: 10px;">
            <button onclick="copyJSONContent()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Copy to Clipboard</button>
            <button onclick="closeJSONModal()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
          </div>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        window.currentJSONModal = modal;
        
        // Store the current JSON content for copying
        window.currentJSONContent = jsonContent;
      } else {
        alert('No JSON data available to display. Please make some changes first.');
      }
    };

    // Function to copy JSON content to clipboard
    window.copyJSONContent = function() {
      // Use the current JSON content that was displayed
      const jsonContent = window.currentJSONContent || window.updatedCombinedJSONContent || window.updatedJSONContent;
      
      if (jsonContent) {
        navigator.clipboard.writeText(jsonContent).then(() => {
          alert('JSON content copied to clipboard!');
        }).catch(() => {
          // Fallback for older browsers
          const textarea = document.querySelector('textarea');
          if (textarea) {
            textarea.select();
            document.execCommand('copy');
            alert('JSON content copied to clipboard!');
          } else {
            alert('Unable to copy to clipboard. Please manually select and copy the content.');
          }
        });
      } else {
        alert('No JSON content available to copy.');
      }
    };

    // Function to close JSON modal
    window.closeJSONModal = function() {
      if (window.currentJSONModal) {
        document.body.removeChild(window.currentJSONModal);
        window.currentJSONModal = null;
      }
    };

    function saveDataToStorage() {
      saveDataToJSON();
    }

    function loadDataFromStorage() {
      // First try to load from localStorage (for session persistence)
      const savedData = localStorage.getItem('equityDashboardData');
      if (savedData) {
        try {
          const parsedData = JSON.parse(savedData);
          if (parsedData.headers) {
            window.headerData = parsedData.headers;
            // Update headers in the DOM
            const headers = document.querySelectorAll('th:not(.text-xs)');
            if (headers[0]) headers[0].textContent = window.headerData.factorHeader;
            if (headers[1]) headers[1].textContent = window.headerData.implicationHeader;
            if (headers[2]) headers[2].textContent = window.headerData.cioViewHeader;
          }
          if (parsedData.factors) {
            window.factorsData = parsedData.factors;
            // Regenerate table with updated data
            const tbody = document.getElementById("factors-body");
            tbody.innerHTML = window.factorsData.map(window.createFactorRow).join("");
          }
          console.log('Factors data loaded from localStorage');
        } catch (e) {
          console.error('Error loading factors data from localStorage:', e);
        }
      }

      // Load CIO View data from localStorage
      const savedCIOViewData = localStorage.getItem('cioViewDashboardData');
      if (savedCIOViewData) {
        try {
          const parsedCIOViewData = JSON.parse(savedCIOViewData);
          if (parsedCIOViewData.assetClasses) {
            window.cioViewData = parsedCIOViewData.assetClasses;
            // Regenerate CIO View table with updated data
            const cioTbody = document.getElementById("cio-view-body");
            cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
          }
          console.log('CIO View data loaded from localStorage');
        } catch (e) {
          console.error('Error loading CIO View data from localStorage:', e);
        }
      }

      // Load Table 3 View data from localStorage
      const savedTable3ViewData = localStorage.getItem('table3ViewDashboardData');
      if (savedTable3ViewData) {
        try {
          const parsedTable3ViewData = JSON.parse(savedTable3ViewData);
          if (parsedTable3ViewData.assetClasses) {
            window.table3ViewData = parsedTable3ViewData.assetClasses;
            // Regenerate Table 3 View table with updated data
            const table3Tbody = document.getElementById("table3-view-body");
            table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
          }
          console.log('Table 3 View data loaded from localStorage');
        } catch (e) {
          console.error('Error loading Table 3 View data from localStorage:', e);
        }
      }

      // Re-initialize editable functionality for new elements
      makeEditable();
      
      return savedData || savedCIOViewData || savedTable3ViewData;
    }

    function importDataFromJSON(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (importedData.headers && importedData.factors) {
            window.headerData = importedData.headers;
            window.factorsData = importedData.factors;
            
            // Update the display
            loadDataFromStorage();
            saveDataToStorage();
            
            console.log('Data imported successfully');
            alert('Data imported successfully!');
          } else {
            throw new Error('Invalid data format');
          }
        } catch (error) {
          console.error('Error importing data:', error);
          alert('Error importing data. Please check the file format.');
        }
      };
      reader.readAsText(file);
    }

    // Global application variables
    let currentData = null;
    let currentHeaderData = null;
    window.cioViewData = [];
    window.table3ViewData = [];

    // Data management functions
    function saveDataToStorage() {
      if (currentData) {
        // Update the current data structure with the latest values
        currentData.assetClassViews = window.cioViewData;
        currentData.table3Views = window.table3ViewData;
        
        localStorage.setItem('dashboard_data', JSON.stringify(currentData));
        console.log('Data saved to localStorage');
      }
    }

    function loadDataFromStorage() {
      const savedData = localStorage.getItem('dashboard_data');
      if (savedData) {
        try {
          currentData = JSON.parse(savedData);
          console.log('Data loaded from localStorage');
          return currentData;
        } catch (error) {
          console.error('Error parsing saved data:', error);
        }
      }
      return null;
    }

    // Utility function to show update notifications
    function showUpdateNotification(message = "Updates saved successfully!") {
      // Remove existing notification if any
      const existingNotif = document.querySelector('.update-notification');
      if (existingNotif) {
        existingNotif.remove();
      }

      // Create and show notification
      const notification = document.createElement('div');
      notification.className = 'update-notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1001;
        font-size: 14px;
        font-weight: 500;
        opacity: 0;
        transition: opacity 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);

      // Fade in
      setTimeout(() => {
        notification.style.opacity = '1';
      }, 100);

      // Fade out and remove
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 2000);
    }

    // Weight update specific notification
    function showWeightUpdateNotification() {
      showUpdateNotification("Weight settings updated successfully!");
    }

    // Initialize the application
    async function initializeApp() {
      console.log('Initializing CIO Viewpoint Dashboard...');
      
      try {
        // Try to load from localStorage first
        let data = loadDataFromStorage();
        
        // If no saved data, load from JSON file
        if (!data) {
          const response = await fetch('./combined_dashboard_data.json');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          data = await response.json();
          console.log('Data loaded from JSON file');
        }
        
        currentData = data;
        currentHeaderData = data.dashboardInfo || {};
        
        // Store data in global variables for table-specific functions
        // Handle both flat array and nested object structures
        window.cioViewData = currentData.assetClassViews?.assetClasses || currentData.assetClassViews || [];
        window.table3ViewData = currentData.table3Views?.sectores || currentData.table3Views?.assetClasses || currentData.table3Views || [];
        window.factorsData = currentData.equityFactors?.factors || currentData.equityFactors || [];
        
        console.log('CIO View Data:', window.cioViewData);
        console.log('Table 3 View Data:', window.table3ViewData);
        console.log('Factors Data:', window.factorsData);
        
        // Populate headers
        if (currentHeaderData.title) {
          const titleElement = document.getElementById('header-title');
          if (titleElement) {
            titleElement.textContent = currentHeaderData.title;
          }
        }
        
        // Handle date from either 'date' or 'lastUpdated' field
        const dateValue = currentHeaderData.date || currentHeaderData.lastUpdated;
        if (dateValue) {
          const dateElement = document.getElementById('header-date');
          if (dateElement) {
            // If it's an ISO date string, format it nicely
            if (dateValue.includes('T')) {
              const date = new Date(dateValue);
              dateElement.textContent = date.toLocaleDateString();
            } else {
              dateElement.textContent = dateValue;
            }
          }
        }
        // Note: subtitle is more complex HTML, so we don't overwrite it entirely
        
        // Populate Table 1 (Equity Factors)
        if (window.factorsData.length > 0) {
          const tbody = document.getElementById("factors-body");
          tbody.innerHTML = window.factorsData.map(window.createFactorRow).join("");
          console.log('Table 1 populated with', window.factorsData.length, 'items');
        } else {
          console.log('Table 1: No data found');
        }
        
        // Populate Table 2 (CIO View)
        if (window.cioViewData.length > 0) {
          const cioTbody = document.getElementById("cio-view-body");
          cioTbody.innerHTML = window.cioViewData.map(window.createAssetClassRow).join("");
          console.log('Table 2 populated with', window.cioViewData.length, 'items');
        } else {
          console.log('Table 2: No data found');
        }
        
        // Populate Table 3
        if (window.table3ViewData.length > 0) {
          const table3Tbody = document.getElementById("table3-view-body");
          table3Tbody.innerHTML = window.table3ViewData.map(window.createTable3sectorRow).join("");
          console.log('Table 3 populated with', window.table3ViewData.length, 'items');
        } else {
          console.log('Table 3: No data found');
        }
        
        // Initialize all interactive functionality
        makeHeadersEditable();
        makeTextCellsEditable();
        
        // Initialize table-specific functionality
        addTable2WeightIndicatorEditing();
        addTable3WeightIndicatorEditing();
        addTable3RowEditing();
        
        console.log('Dashboard initialized successfully');
        
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        showUpdateNotification('Error loading dashboard data');
      }
    }

    // Start the application when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeApp);

    // JSON Preview and Copy Functions
    function previewJSON() {
      const currentJSONData = generateCurrentJSONData();
      showJSONPreviewModal(currentJSONData);
    }

    function copyCurrentJSON() {
      const currentJSONData = generateCurrentJSONData();
      const jsonString = JSON.stringify(currentJSONData, null, 2);
      
      navigator.clipboard.writeText(jsonString).then(() => {
        showCopySuccessNotification();
      }).catch(() => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = jsonString;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showCopySuccessNotification();
      });
    }

    function generateCurrentJSONData() {
      // Get current data from the dashboard
      const currentJSONData = {
        dashboardInfo: {
          title: document.getElementById('header-title')?.textContent || 'CIO Viewpoint Dashboard',
          subtitle: 'Comprehensive Investment Outlook',
          lastUpdated: new Date().toISOString(),
          version: '1.0'
        },
        equityFactors: {
          headers: window.headerData || {
            factorHeader: 'Factor',
            implicationHeader: 'Implication for Equities',
            cioViewHeader: 'CIO View'
          },
          subtitle: 'Current readings on the key drivers of Equities for investors to consider, with arrows representing the recent trend:',
          factors: window.factorsData || []
        },
        assetClassViews: {
          headers: {
            assetClassHeader: 'Asset Class',
            cioViewHeader: 'CIO View',
            commentsHeader: 'Comments'
          },
          subtitle: 'Current CIO views on asset classes with weight recommendations:',
          footnote: '*Asia Pac ex-Japan refers to the geographic area surrounding the Pacific Ocean.',
          assetClasses: window.cioViewData || []
        },
        table3Views: {
          headers: {
            sectorHeader: 'Sector',
            cioViewHeader: 'CIO View',
            commentsHeader: 'Comments'
          },
          subtitle: 'Additional CIO views on asset classes with weight recommendations:',
          footnote: '*This table represents additional asset class considerations for portfolio construction.',
          sectores: window.table3ViewData || []
        }
      };

      return currentJSONData;
    }

    function showJSONPreviewModal(jsonData) {
      // Remove existing modal if any
      const existingModal = document.querySelector('.json-preview-modal');
      if (existingModal) {
        existingModal.remove();
      }

      // Create modal overlay
      const modal = document.createElement('div');
      modal.className = 'json-preview-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1100;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: modalFadeIn 0.3s ease;
      `;

      // Create modal content
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 90%;
        max-height: 90%;
        overflow: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
      `;

      const jsonString = JSON.stringify(jsonData, null, 2);
      
      content.innerHTML = `
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; gap: 15px;">
          <h3 style="margin: 0; font-size: 20px; font-weight: bold; color: #333;">JSON Data Preview</h3>
          <div style="display: flex; gap: 10px; margin-left: auto;">
            <button onclick="copyJSONFromModal()" style="
              padding: 8px 16px; 
              background: #28a745; 
              color: white; 
              border: none; 
              border-radius: 6px; 
              cursor: pointer; 
              font-size: 14px;
              font-weight: 500;
              display: flex;
              align-items: center;
              gap: 6px;
            ">
              📋 Copy JSON
            </button>
            <button onclick="closeJSONPreviewModal()" style="
              padding: 8px 16px; 
              background: #6c757d; 
              color: white; 
              border: none; 
              border-radius: 6px; 
              cursor: pointer; 
              font-size: 14px;
              font-weight: 500;
            ">
              ✕ Close
            </button>
          </div>
        </div>
        
        <div style="margin-bottom: 15px;">
          <p style="margin: 0; font-size: 14px; color: #666;">
            Current dashboard data in JSON format. You can copy this to save your current state.
          </p>
        </div>
        
        <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; border: 1px solid #e9ecef;">
          <pre style="
            margin: 0; 
            font-family: 'Monaco', 'Consolas', monospace; 
            font-size: 12px; 
            line-height: 1.4; 
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow-y: auto;
          ">${jsonString}</pre>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      // Store JSON for copying
      window.currentPreviewJSON = jsonString;

      // Close modal when clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeJSONPreviewModal();
        }
      });

      // Add fade-in animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes modalFadeIn {
          from { opacity: 0; transform: scale(0.9); }
          to { opacity: 1; transform: scale(1); }
        }
      `;
      document.head.appendChild(style);
    }

    function copyJSONFromModal() {
      const jsonString = window.currentPreviewJSON;
      if (jsonString) {
        navigator.clipboard.writeText(jsonString).then(() => {
          showCopySuccessNotification('JSON data copied from preview!');
        }).catch(() => {
          // Fallback
          const textarea = document.createElement('textarea');
          textarea.value = jsonString;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showCopySuccessNotification('JSON data copied from preview!');
        });
      }
    }

    function closeJSONPreviewModal() {
      const modal = document.querySelector('.json-preview-modal');
      if (modal) {
        modal.style.animation = 'modalFadeOut 0.2s ease';
        setTimeout(() => {
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
        }, 200);
      }
    }

    function showCopySuccessNotification(message = 'JSON data copied to clipboard!') {
      // Remove existing notification if any
      const existingNotif = document.querySelector('.copy-success-notification');
      if (existingNotif) {
        existingNotif.remove();
      }

      const notification = document.createElement('div');
      notification.className = 'copy-success-notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        z-index: 1200;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        opacity: 0;
        transform: translateX(100px);
        transition: all 0.3s ease;
      `;
      notification.innerHTML = `✅ ${message}`;
      document.body.appendChild(notification);

      // Animate in
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      }, 100);

      // Animate out and remove
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Add fade-out animation
    const modalStyle = document.createElement('style');
    modalStyle.textContent = `
      @keyframes modalFadeOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.9); }
      }
    `;
    document.head.appendChild(modalStyle);
  </script>
</body>
</html>
